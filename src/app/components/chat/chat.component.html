<div class="app-container" [ngClass]="currentView">
    <!-- Header -->
    <header class="app-header">
        <button class="menu-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>
        <h1 class="app-title">SandClock Assistant</h1>
        <button class="close-btn" (click)="logout()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </header>

    <!-- Welcome View -->
    <div class="welcome-view" *ngIf="currentView === 'welcome'">
        <div class="welcome-content">
            <div class="sparkle-icon">
                <svg width="80" height="80" viewBox="0 0 80 80" fill="#FFB380">
                    <path d="M40 0 L45 35 L80 40 L45 45 L40 80 L35 45 L0 40 L35 35 Z" />
                    <path d="M60 15 L62 25 L72 27 L62 29 L60 39 L58 29 L48 27 L58 25 Z" />
                </svg>
            </div>
            <h2 class="welcome-title">Welcome to <span class="highlight">SandClock Assistant</span></h2>
            <p class="welcome-subtitle">What would you like to check?</p>

            <div class="action-buttons">
                <button class="action-btn" (click)="handleAction('todayWork', 'Today\'s Tasks')">
                    <span class="action-title">Today's Tasks</span>
                    <span class="action-desc">See what you need to do today</span>
                </button>
                <button class="action-btn" (click)="handleAction('weekWork', 'Last Week\'s Tasks')">
                    <span class="action-title">Last Week's Tasks</span>
                    <span class="action-desc">Review your recent progress</span>
                </button>
                <button class="action-btn" (click)="handleAction('leavePlan', 'Leave Plan')">
                    <span class="action-title">Leave Plan</span>
                    <span class="action-desc">Check if you can take a day off</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Date Picker View -->
    <div class="datepicker-view" *ngIf="currentView === 'datepicker'">
        <div class="datepicker-content">
            <h2 class="datepicker-title">Let's plan your time off.</h2>
            <p class="datepicker-subtitle">Which day are you planning to take off?</p>

            <div class="calendar-container">
                <div class="calendar-header">
                    <button class="nav-btn" (click)="previousMonth()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="15 18 9 12 15 6"></polyline>
                        </svg>
                    </button>

                    <div class="month-year-selectors">
                        <select class="month-select" [(ngModel)]="currentMonth" (change)="generateCalendar()">
                            <option *ngFor="let month of monthNames; let i = index" [value]="i">{{ month }}</option>
                        </select>
                        <select class="year-select" [(ngModel)]="currentYear" (change)="generateCalendar()">
                            <option *ngFor="let year of [2024, 2025, 2026, 2027]" [value]="year">{{ year }}</option>
                        </select>
                    </div>

                    <button class="nav-btn" (click)="nextMonth()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="9 18 15 12 9 6"></polyline>
                        </svg>
                    </button>
                </div>

                <div class="calendar-grid">
                    <div class="day-name" *ngFor="let dayName of dayNames">{{ dayName }}</div>
                    <div *ngFor="let day of calendarDays" class="calendar-day" [class.empty]="day === null"
                        [class.selected]="isSelectedDate(day)" (click)="selectDate(day)">
                        {{ day }}
                    </div>
                </div>
            </div>

            <div class="datepicker-actions">
                <button class="confirm-btn" (click)="confirmDate()">Confirm date</button>
                <button class="back-btn-datepicker" (click)="goBackFromDatePicker()">Back</button>
            </div>
        </div>
    </div>

    <!-- Results View -->
    <div class="results-view" *ngIf="currentView === 'results'">
        <div class="results-header">
            <h2 class="results-title">{{ currentActionTitle }}</h2>
        </div>

        <div class="results-content" #scrollContainer>
            <div *ngFor="let msg of messages" class="message-item">
                <ng-container *ngIf="msg.parts && msg.parts.length > 0; else legacyText">
                    <ng-container *ngFor="let part of msg.parts">
                        <div *ngIf="part.type === 'text'" class="message-text"
                            [innerHTML]="parseMarkdown(part.content)"></div>
                        <div *ngIf="part.type === 'tool_use'" class="tool-use-block" [class.open]="part.isOpen">
                            <div class="tool-header" (click)="part.isOpen = !part.isOpen">
                                <span class="tool-icon">üõ†Ô∏è</span>
                                <span class="tool-name">Used tool: {{ part.toolName }}</span>
                                <span class="toggle-icon">{{ part.isOpen ? '‚ñº' : '‚ñ∂' }}</span>
                            </div>
                            <div class="tool-content" *ngIf="part.isOpen">
                                <pre>{{ part.content }}</pre>
                            </div>
                        </div>
                    </ng-container>
                </ng-container>
                <ng-template #legacyText>
                    <div class="message-text" [innerHTML]="parseMarkdown(msg.text)"></div>
                </ng-template>
            </div>

            <div *ngIf="isLoading" class="loading-indicator">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>

        <div class="results-footer">
            <button class="back-btn" (click)="goBack()">Back</button>
        </div>
    </div>

    <!-- Token Debug Panel (Bottom-Left) -->
    <div class="token-panel">
        <button class="token-toggle" (click)="toggleTokenPanel()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            {{ showTokenPanel ? 'Hide' : 'Tokens' }}
        </button>

        <div class="token-content" *ngIf="showTokenPanel">
            <div class="token-item">
                <label>Azure Token:</label>
                <div class="token-display">
                    <input type="text" [value]="azureToken" readonly>
                    <button (click)="copyToken(azureToken, 'Azure')" class="copy-btn">Copy</button>
                </div>
            </div>

            <div class="token-item">
                <label>M365 Token:</label>
                <div class="token-display">
                    <input type="text" [value]="m365Token" readonly>
                    <button (click)="copyToken(m365Token, 'M365')" class="copy-btn">Copy</button>
                </div>
            </div>

            <div class="token-item">
                <label>Pastel Auth Token:</label>
                <div class="token-display">
                    <input type="text" [value]="pastelAuthToken" readonly>
                    <button (click)="copyToken(pastelAuthToken, 'Pastel')" class="copy-btn">Copy</button>
                </div>
            </div>

            <div class="token-item">
                <label>Pastel Email:</label>
                <div class="token-display">
                    <input type="text" [value]="pastelEmail" readonly>
                    <button (click)="copyToken(pastelEmail, 'Email')" class="copy-btn">Copy</button>
                </div>
            </div>

            <div class="token-item">
                <label>Machine Name:</label>
                <div class="token-display">
                    <input type="text" [value]="machineName" readonly>
                    <button (click)="copyToken(machineName, 'Machine Name')" class="copy-btn">Copy</button>
                </div>
            </div>
        </div>
    </div>
</div>